<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href = "../ext-3.3.0/resources/css/ext-all.css" type = "text/css" rel = "stylesheet"/>
        <script src = "../ext-3.3.0/adapter/ext/ext-base.js" type = "text/javascript"></script>
        <script src = "../ext-3.3.0/ext-all.js"></script>

        <style type="text/css">
            .body{
                font-size: 20px
            }
        </style>

        <script type = "text/javascript">

            var createItem = (name) =>{
                return {
                    text: name,
                    leaf: true
                }
            }
            
            Ext.onReady(function(){

                var addStudent = (selectedNode, val)=> {
                    if(schoolNode == selectedNode.parentNode){
                        if(selectedNode.leaf)
                            selectedNode.leaf = false;
                        selectedNode.appendChild(createItem(val));

                    }else if(selectedNode.parentNode != null){
                        selectedNode.parentNode.appendChild(createItem(val));
                    }                               
                }
                
                var addClass = (val) => {      
                    schoolNode.appendChild(createItem(val));
                }

                var menu = new Ext.menu.Menu({
                    items:[{
                        id:'addStudent',
                        text: 'add Student'
                    },{
                        id: 'addClass',
                        text:'add class'
                    }],
                    listeners:{
                        itemclick:function(item){
                            console.log('jinlaile');
                            let currentNode = item.parentMenu.contextNode;
                            switch(item.id){
                                case 'addStudent':
                                    Ext.Msg.prompt('add Student','please enter the student name',function(btn,text){
                                        console.log(text);
                                        if(btn == 'ok')
                                            addStudent(currentNode,text);
                                    });
                                    break;
                                case 'addClass':
                                    Ext.Msg.prompt('add class','please enter the class name',function(btn,text){
                                        console.log(text);
                                        if(btn == 'ok')
                                            addClass(text);
                                    });
                                    break;
                            }
                        }
                    }
                });


                var tree = new Ext.tree.TreePanel({
                    useArrows:true,
                    //border:false,
                    //cls:'treeCss',
                    //containerScroll: true,   
                    loader: new Ext.tree.TreeLoader({dataUrl:'student_class_information.txt'}),
                    root: new Ext.tree.AsyncTreeNode({text:'Áà±ÂøÉÂ∞èÂ≠¶üè´'}),
                    contextMenu: menu,
                    listeners:{
                        click: function(node){
                            this.selectedNode = node;
                        },
                        contextmenu:function(node,event){
                            node.select();
                            console.log(node);
                            node.select();
                            var treeContextMenu = node.getOwnerTree().contextMenu;
                            treeContextMenu.contextNode = node;
                            treeContextMenu.showAt(event.getXY());
                        }
                    }
                });

                var schoolNode = tree.root;

                var inputPanel = new Ext.TabPanel({
                    id:'inputPanel',
                    activeTab:0,
                    width:400,
                    height:100,
                    items:[
                        {
                            id:'student',
                            title:'student',
                            xtype:'textfield'
                        },{
                            id:'class',
                            title:'class',
                            xtype:'textfield'
                        }
                    ],
                    buttons:[
                        {
                            text:'add',
                            listeners:{
                                click:function(){
                                    let inputPanel = Ext.getCmp('inputPanel');
                                    let type = inputPanel.getActiveTab().title;
                                    let selectedNote = tree.selectedNode;

                                    let temp;
                                    if(selectedNote == null)
                                        return ;

                                    if(type === 'student'){
                                        //let student = Ext.getCmp('student');
                                        temp = Ext.getCmp('student');
                                        addStudent(selectedNote,temp.getValue());  
                                    }else if(type === 'class'){
                                        temp = Ext.getCmp('class');
                                        addClass(temp.getValue());
                                    }

                                    //inputPanel.setValue('');
                                    temp.setValue('');
                                    console.log(inputPanel);
                                }
                            }
                        }
                    ]
                });

                var treeEditor = new Ext.tree.TreeEditor(tree,{
                    allowBlank:false
                },{
                    listeners:{
                        complete: function(){
                            console.log('is changed');
                        }
                    }
                });

                

                var viewport = new Ext.Viewport({
                    title:'student manager',
                    items:[tree,inputPanel]
                });
            });
        </script>
    </head>
    <body>
    </body>
</html>